;(function ($, window, document, undefined) {
  var pluginName = "equalize",
    defaults = {
      selector: '> div',
      responsive: false
    };

  function Plugin(element, options) {
    this.element = element;
    this.$element = $(element);

    this.options = $.extend({}, defaults, options);

    this._defaults = defaults;
    this._name = pluginName;

    this.initialize();
  }

  Plugin.prototype = {
    initialize: function() {
      this.columns = this.$element.find(this.options.selector);

      if(this.options.responsive){
        this.timeout;
        $(window).resize($.proxy(this.onResize,this)).resize();
      } else {
        this.equalize();
      }

      //this.columns.on('DOMSubtreeModified DOMNodeInserted DOMNodeRemoved', $.proxy(this.equalize, this));
      this.columns.find('img').on('load', $.proxy(this.equalize, this));
    },

    onResize: function(){
      clearTimeout(this.timeout);
      this.timeout = setTimeout($.proxy(this.equalize,this),200);
    },

    equalize: function(){
      this.columns.css('height', 'auto');

      setTimeout($.proxy(function(){
        this.columns.outerHeight(this.max());
      }, this), 1);
    },

    max: function(){
      var height = 0;
      var maxHeight = 0;

      for(var i = 0; i < this.columns.length; i++){
        height = $(this.columns[i]).outerHeight();

        if(height > maxHeight){
          maxHeight = height;
        }
      }

      return maxHeight;
    }
  };

  $.fn[pluginName] = function (options) {
    return this.each(function () {
      if (!$.data(this, "plugin_" + pluginName)) {
        $.data(this, "plugin_" + pluginName, new Plugin(this, options));
      }
    });
  };

})(jQuery, window, document);
